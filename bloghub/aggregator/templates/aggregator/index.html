{% extends 'aggregator/base.html' %}

{% block title %}BlogHub - Tổng hợp Blog Cá nhân{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="bg-blue-600 p-6 text-white mb-6">
    <h1 class="text-2xl font-bold mb-2">Chào mừng đến với BlogHub! 👋</h1>
    <p class="text-blue-100">Tổng hợp và khám phá nội dung từ các blog cá nhân hàng đầu</p>
</div>

<!-- Filters Section -->
<div class="bg-white border border-gray-300 p-4 mb-6">
    <div class="flex flex-col md:flex-row gap-4">
        <!-- Search -->
        <div class="flex-1">
            <label for="search" class="block text-sm font-medium text-gray-700 mb-2">Tìm kiếm</label>
            <input 
                type="text" 
                id="search" 
                name="search"
                value="{{ search_query }}"
                placeholder="Tìm kiếm theo tiêu đề hoặc nội dung..."
                class="w-full px-4 py-2 border border-gray-400 focus:border-blue-600 focus:outline-none"
            >
        </div>
        
        <!-- Blog Source Filter -->
        <div class="md:w-64">
            <label for="blog_source" class="block text-sm font-medium text-gray-700 mb-2">Lọc theo blog</label>
            <select 
                name="blog_source" 
                id="blog_source"
                class="w-full px-4 py-2 border border-gray-400 focus:border-blue-600 focus:outline-none"
            >
                <option value="">Tất cả blog</option>
                {% for source in blog_sources %}
                    <option value="{{ source.id }}" {% if source.id|stringformat:"s" == current_blog_source %}selected{% endif %}>
                        {{ source.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<!-- Posts Masonry Container -->
<div id="posts-masonry" class="masonry-grid">
    {% include 'aggregator/partials/post_list.html' %}
</div>

<!-- Infinity Scroll Trigger -->
<div id="scroll-trigger" 
     hx-get="{% url 'aggregator:load_more_posts' %}"
     hx-trigger="intersect once"
     hx-target="#posts-masonry"
     hx-swap="beforeend"
     hx-include="[name='search'], [name='blog_source']"
     hx-indicator="#loading-indicator"
     class="h-20 flex items-center justify-center">
    <div class="text-gray-500 text-sm">Đang tải thêm bài viết...</div>
</div>

<!-- End of content marker -->
<div id="end-marker" class="hidden text-center py-8 text-gray-500">
    <p>🎉 Bạn đã xem hết tất cả bài viết!</p>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let isLoading = false;
let hasMorePosts = true;

// Handle search and filter changes
function handleFilterChange() {
    if (isLoading) return;
    
    isLoading = true;
    currentPage = 1;
    hasMorePosts = true;
    
    // Hide end marker
    document.getElementById('end-marker').classList.add('hidden');
    
    const search = document.getElementById('search').value;
    const blogSource = document.getElementById('blog_source').value;
    
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (blogSource) params.append('blog_source', blogSource);
    params.append('page', currentPage);
    
    // Clear current posts
    document.getElementById('posts-masonry').innerHTML = '';
    
    // Load new posts
    fetch(`{% url 'aggregator:load_more_posts' %}?${params.toString()}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('posts-masonry').innerHTML = html;
            setupScrollTrigger();
            isLoading = false;
        })
        .catch(error => {
            console.error('Error:', error);
            isLoading = false;
        });
}

// Setup infinity scroll trigger
function setupScrollTrigger() {
    const trigger = document.getElementById('scroll-trigger');
    if (!trigger || !hasMorePosts) return;
    
    // Remove old trigger and create new one
    trigger.remove();
    
    const newTrigger = document.createElement('div');
    newTrigger.id = 'scroll-trigger';
    newTrigger.className = 'h-20 flex items-center justify-center';
    newTrigger.innerHTML = '<div class="text-gray-500 text-sm">Đang tải thêm bài viết...</div>';
    
    // Add HTMX attributes
    const search = document.getElementById('search').value;
    const blogSource = document.getElementById('blog_source').value;
    
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (blogSource) params.append('blog_source', blogSource);
    params.append('page', currentPage + 1);
    
    newTrigger.setAttribute('hx-get', `{% url 'aggregator:load_more_posts' %}?${params.toString()}`);
    newTrigger.setAttribute('hx-trigger', 'intersect once');
    newTrigger.setAttribute('hx-target', '#posts-masonry');
    newTrigger.setAttribute('hx-swap', 'beforeend');
    
    document.getElementById('posts-masonry').parentNode.insertBefore(
        newTrigger, 
        document.getElementById('end-marker')
    );
    
    // Reinitialize HTMX for new element
    htmx.process(newTrigger);
}

// Handle successful HTMX requests
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.target.id === 'scroll-trigger') {
        currentPage++;
        
        // Check if we got any new posts
        const response = event.detail.xhr.responseText;
        if (response.trim() === '' || response.includes('Không có bài viết nào')) {
            hasMorePosts = false;
            document.getElementById('scroll-trigger').remove();
            document.getElementById('end-marker').classList.remove('hidden');
        } else {
            setupScrollTrigger();
        }
        
        isLoading = false;
    }
});

// Add event listeners for filters
document.getElementById('search').addEventListener('input', debounce(handleFilterChange, 500));
document.getElementById('blog_source').addEventListener('change', handleFilterChange);

// Debounce function for search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    setupScrollTrigger();
});
</script>
{% endblock %}