{% extends 'aggregator/base.html' %}

{% block title %}T·∫•t c·∫£ b√†i vi·∫øt - BlogHub{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-white border border-gray-300 p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-gray-900">üìã T·∫•t c·∫£ b√†i vi·∫øt</h1>
        <a href="{% url 'aggregator:index' %}" class="text-blue-600 text-sm hover:text-blue-700">‚Üê V·ªÅ trang ch·ªß</a>
    </div>
    
    <!-- Filters -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Search -->
        <div>
            <input 
                type="text" 
                id="search" 
                name="search"
                value="{{ search_query }}"
                placeholder="T√¨m ki·∫øm..."
                class="w-full px-3 py-2 border border-gray-400 focus:border-blue-600 focus:outline-none text-sm"
            >
        </div>
        
        <!-- Post Type -->
        <div>
            <select 
                name="type" 
                id="type"
                class="w-full px-3 py-2 border border-gray-400 focus:border-blue-600 focus:outline-none text-sm"
            >
                <option value="all" {% if current_type == "all" %}selected{% endif %}>T·∫•t c·∫£</option>
                <option value="external" {% if current_type == "external" %}selected{% endif %}>Blog ngo√†i</option>
                <option value="my" {% if current_type == "my" %}selected{% endif %}>Blog c·ªßa ch√∫ng t√¥i</option>
            </select>
        </div>
        
        <!-- Category -->
        <div>
            <select 
                name="category" 
                id="category"
                class="w-full px-3 py-2 border border-gray-400 focus:border-blue-600 focus:outline-none text-sm"
            >
                <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                {% for category in categories %}
                    <option value="{{ category.id }}" {% if category.id|stringformat:"s" == current_category %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Blog Source (for external posts) -->
        <div>
            <select 
                name="blog_source" 
                id="blog_source"
                class="w-full px-3 py-2 border border-gray-400 focus:border-blue-600 focus:outline-none text-sm"
            >
                <option value="">T·∫•t c·∫£ blog</option>
                {% for source in blog_sources %}
                    <option value="{{ source.id }}" {% if source.id|stringformat:"s" == current_blog_source %}selected{% endif %}>
                        {{ source.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<!-- Posts Masonry Container -->
<div id="posts-masonry" class="masonry-grid">
    {% include 'aggregator/partials/all_post_list.html' %}
</div>

<!-- Infinity Scroll Trigger -->
<div id="scroll-trigger" 
     hx-get="{% url 'aggregator:load_more_posts' %}"
     hx-trigger="intersect once"
     hx-target="#posts-masonry"
     hx-swap="beforeend"
     hx-include="[name='search'], [name='type'], [name='category'], [name='blog_source']"
     hx-indicator="#loading-indicator"
     class="h-20 flex items-center justify-center">
    <div class="text-gray-500 text-sm">ƒêang t·∫£i th√™m b√†i vi·∫øt...</div>
</div>

<!-- End of content marker -->
<div id="end-marker" class="hidden text-center py-8 text-gray-500">
    <p>üéâ B·∫°n ƒë√£ xem h·∫øt t·∫•t c·∫£ b√†i vi·∫øt!</p>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let isLoading = false;
let hasMorePosts = true;

// Handle search and filter changes
function handleFilterChange() {
    if (isLoading) return;
    
    isLoading = true;
    currentPage = 1;
    hasMorePosts = true;
    
    // Hide end marker
    document.getElementById('end-marker').classList.add('hidden');
    
    const search = document.getElementById('search').value;
    const type = document.getElementById('type').value;
    const category = document.getElementById('category').value;
    const blogSource = document.getElementById('blog_source').value;
    
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (type) params.append('type', type);
    if (category) params.append('category', category);
    if (blogSource) params.append('blog_source', blogSource);
    params.append('page', currentPage);
    
    // Clear current posts
    document.getElementById('posts-masonry').innerHTML = '';
    
    // Load new posts
    fetch(`{% url 'aggregator:load_more_posts' %}?${params.toString()}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('posts-masonry').innerHTML = html;
            setupScrollTrigger();
            isLoading = false;
        })
        .catch(error => {
            console.error('Error:', error);
            isLoading = false;
        });
}

// Setup infinity scroll trigger
function setupScrollTrigger() {
    const trigger = document.getElementById('scroll-trigger');
    if (!trigger || !hasMorePosts) return;
    
    // Remove old trigger and create new one
    trigger.remove();
    
    const newTrigger = document.createElement('div');
    newTrigger.id = 'scroll-trigger';
    newTrigger.className = 'h-20 flex items-center justify-center';
    newTrigger.innerHTML = '<div class="text-gray-500 text-sm">ƒêang t·∫£i th√™m b√†i vi·∫øt...</div>';
    
    // Add HTMX attributes
    const search = document.getElementById('search').value;
    const type = document.getElementById('type').value;
    const category = document.getElementById('category').value;
    const blogSource = document.getElementById('blog_source').value;
    
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (type) params.append('type', type);
    if (category) params.append('category', category);
    if (blogSource) params.append('blog_source', blogSource);
    params.append('page', currentPage + 1);
    
    newTrigger.setAttribute('hx-get', `{% url 'aggregator:load_more_posts' %}?${params.toString()}`);
    newTrigger.setAttribute('hx-trigger', 'intersect once');
    newTrigger.setAttribute('hx-target', '#posts-masonry');
    newTrigger.setAttribute('hx-swap', 'beforeend');
    
    document.getElementById('posts-masonry').parentNode.insertBefore(
        newTrigger, 
        document.getElementById('end-marker')
    );
    
    // Reinitialize HTMX for new element
    htmx.process(newTrigger);
}

// Handle successful HTMX requests
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.target.id === 'scroll-trigger') {
        currentPage++;
        
        // Check if we got any new posts
        const response = event.detail.xhr.responseText;
        if (response.trim() === '' || response.includes('Kh√¥ng c√≥ b√†i vi·∫øt n√†o')) {
            hasMorePosts = false;
            document.getElementById('scroll-trigger').remove();
            document.getElementById('end-marker').classList.remove('hidden');
        } else {
            setupScrollTrigger();
        }
        
        isLoading = false;
    }
});

// Add event listeners for filters
document.getElementById('search').addEventListener('input', debounce(handleFilterChange, 500));
document.getElementById('type').addEventListener('change', handleFilterChange);
document.getElementById('category').addEventListener('change', handleFilterChange);
document.getElementById('blog_source').addEventListener('change', handleFilterChange);

// Debounce function for search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    setupScrollTrigger();
});
</script>
{% endblock %}